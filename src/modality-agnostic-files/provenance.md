# Provenance

Support for provenance was developed as a [BIDS Extension Proposal](../extensions.md#bids-extension-proposals).
Please see [Citing BIDS](../introduction.md#citing-bids) on how to appropriately credit this extension when referring to it in the
context of the academic literature.

!!! bug
    Change example links below once they are merged to bids-examples

!!! example "Example datasets"

    The following examples have been formatted using this specification
    and can be used for practical guidance when curating a new dataset.

    - [Provenance records for DICOM to Nifti conversion using `dcm2niix`](https://github.com/bids-standard/bids-examples/pull/494)
    - [Provenance records for DICOM to Nifti conversion using `heudiconv`](https://github.com/bids-standard/bids-examples/pull/496)
    - [Provenance records for SPM fMRI preprocessing](https://github.com/bids-standard/bids-examples/pull/497)

    Further datasets are available from
    the [BIDS examples repository](https://bids-website.readthedocs.io/en/latest/datasets/examples.html#provenance).

## Overview

### Goals

This part of the BIDS specification is aimed at describing the provenance of a BIDS dataset. This description is retrospective : it describes a set of steps that were executed in order to obtain the dataset (this is different from prospective descriptions of workflows that could for instance list all sets of steps that can be run on this dataset).

### Principles for encoding provenance in BIDS

-   Provenance information SHOULD be included in a BIDS dataset when possible.
-   If provenance records are included, these MUST be described using the conventions detailed by this specification.
-   Provenance records MAY be used to reflect the provenance of a dataset, a collection of files or a specific file at any level of the BIDS hierarchy.
-   Provenance information SHOULD be anonymized/de-identified as necessary.

### Definitions

**Provenance record** : provenance metadata consists in sets of records. These provenance records can be of 4 types:
-   `Activity`: Activities represent the transformations that have been applied to the data.
-   `Entity`: Each Activity can use Entities as inputs and outputs.
-   `Software`: The Software record describes a software package.
-   `Environment`: Environments specify the software environment in which the provenance record was obtained.

Provenance records are described as JSON objects in BIDS. This is detailed in the [Provenance files section](#provenance-files).

**Provenance group** : defining multiple provenance records groups is appropriate when separate sets of processings have been performed on data.



## Provenance in sidecar JSON files

Provenance metadata can be stored inside the sidecar JSON of any BIDS file (or BIDS-Derivatives file) it applies to.
In this case, the provenance content only refers to the associated data file.

Inside the sidecar JSON, the `GenearatedBy` field must contain the `Id` of the `Activity` that generated the data file. This `Activity` must be described inside a [provenance file](#provenance-files) of the dataset.

!!! example
    ```JSON
    {
        "GeneratedBy": "bids::prov#conversion-00f3a18f",
    }
    ```

Based on the same principle, the `SidecarGenearatedBy` field can be defined to describe the `Activity` that generated the sidecar JSON file.
Not defining the `SidecarGenearatedBy` field means that the sidecar JSON was generated by the `Activity` described in the `GenearatedBy` field.

Furthermore, the `Digest` and `Type` fields can be defined, as described in the [Entity section](#entity).

No other field is allowed to describe provenance inside sidecar JSONs.

## Provenance at dataset level

In the current version of the BIDS specification (1.10.0), the `GeneratedBy` field of the `dataset_description.json` files allows to specify provenance of the dataset.

BEP028 proposes that the following description replaces the `GeneratedBy` field as part of a major revision of the BIDS specification. Until this happens, provenance records can be stored in a `GeneratedByProv` field.

As for sidecar JSON files, the `GeneratedByProv` field must contain the `Id` of the `Activity` that generated the data file. This `Activity` must be described inside a [provenance file](#provenance-files) of the dataset.

!!! example
    ```JSON
    {
        "GeneratedByProv": "bids::prov#conversion-00f3a18f"
    }
    ```

## Provenance files

Template:

```text
prov/
    [<label>/]
        prov-<label>_act.json
        prov-<label>_ent.json
        prov-<label>_env.json
        prov-<label>_soft.json
```

The `prov` entity specifies that provenance records in the files belong to the same provenance group.

!!! example
    In this example, two separated sets of processings (`preprocspm` and `preprocfsl`) were performed on the data, resulting in two groups of provenance records.
    ```
    prov/
    ├─ preprocspm/
    │  ├─ prov-preprocspm_act.json
    │  └─ prov-preprocspm_ent.json
    ├─ prov-preprocfsl_act.json
    ├─ prov-preprocfsl_ent.json
    ├─ prov-preprocfsl_env.json
    ├─ prov-preprocfsl_soft.json
    └─ ...
    ```

The following suffixes specify the contents of a provenance file.

<!--
This block generates a suffix table.
The definitions of these fields can be found in
  src/schema/objects/suffixes
and a guide for using macros can be found at
 https://github.com/bids-standard/bids-specification/blob/master/macros_doc.md
-->
{{ MACROS___make_suffix_table(
      ["act", "ent", "env", "soft"]
   )
}}

![](../images/prov_records.svg)

### `Activity` records

Each `prov/[<label>/]prov-<label>_act.json` file is a JSON file describing `Activity` records for a provenance group.

This file MUST include an `Activities` key:

<!-- This block generates a metadata table.
The definitions of these fields can be found in
  src/schema/objects/metadata.yaml
and a guide for using macros can be found at
 https://github.com/bids-standard/bids-specification/blob/master/macros_doc.md
-->
{{ MACROS___make_metadata_table(
   {
      "Activities": "REQUIRED"
   }
) }}

Each object in the `Activities` array includes the following keys:

<!-- This block generates a table describing subfields within a metadata field.
The definitions of these fields can be found in
  src/schema/objects/metadata.yaml
and a guide for using macros can be found at
 https://github.com/bids-standard/bids-specification/blob/master/macros_doc.md
-->
{{ MACROS___make_subobject_table("metadata.Activities.items") }}

!!! example "Example:"
    ```JSON
    {
        "Activities": [
            {
                "Id": "bids::prov/#conversion-00f3a18f",
                "Label": "Dicom to Nifti conversion",
                "Command": "dcm2niix -o . -f sub-%i/anat/sub-%i_T1w sourcedata/dicoms",
                "AssociatedWith": "bids::prov/#dcm2niix-khhkm7u1",
                "Used": [
                    "bids::prov/#fedora-uldfv058",
                    "bids::sourcedata/dicoms"
                ],
                "StartedAtTime": "2025-03-13T10:26:00",
                "EndedAtTime": "2025-03-13T10:26:05"
            }
        ]
    }
    ```


### `Entity` records

Each `prov/[<label>/]prov-<label>_ent.json` file is a JSON file describing `Entity` records for a provenance group.

This file MUST include an `Entities` key:

<!-- This block generates a metadata table.
The definitions of these fields can be found in
  src/schema/objects/metadata.yaml
and a guide for using macros can be found at
 https://github.com/bids-standard/bids-specification/blob/master/macros_doc.md
-->
{{ MACROS___make_metadata_table(
   {
      "Entities": "REQUIRED"
   }
) }}

Each object in the `Entities` array includes the following keys:

<!-- This block generates a table describing subfields within a metadata field.
The definitions of these fields can be found in
  src/schema/objects/metadata.yaml
and a guide for using macros can be found at
 https://github.com/bids-standard/bids-specification/blob/master/macros_doc.md
-->
{{ MACROS___make_subobject_table("metadata.Entities.items") }}

!!! example "Example"
    ```JSON
    {
        "Entities": [
            {
                "Id": "bids::sub-02/anat/sub-02_T1w.nii",
                "Label": "sub-02_T1w.nii",
                "AtLocation": "sub-02/anat/sub-02_T1w.nii",
                "GeneratedBy": "bids::prov/#conversion-00f3a18f",
                "Digest": {
                    "SHA-256": "42d8faeaa6d4988a9233a95860ef3f481fb0daccce4c81bc2c1634ea8cf89e52"
                }
            }
        ]
    }
    ```

### `Software` records

Each `prov/[<label>/]prov-<label>_soft.json` file is a JSON file describing `Software` records for a provenance group.

This file MUST include a `Software` key:

<!-- This block generates a metadata table.
The definitions of these fields can be found in
  src/schema/objects/metadata.yaml
and a guide for using macros can be found at
 https://github.com/bids-standard/bids-specification/blob/master/macros_doc.md
-->
{{ MACROS___make_metadata_table(
   {
      "Software": "REQUIRED"
   }
) }}

Each object in the `Software` array includes the following keys:

<!-- This block generates a table describing subfields within a metadata field.
The definitions of these fields can be found in
  src/schema/objects/metadata.yaml
and a guide for using macros can be found at
 https://github.com/bids-standard/bids-specification/blob/master/macros_doc.md
-->
{{ MACROS___make_subobject_table("metadata.Software.items") }}

!!! example "Example"
    ```JSON
    {
        "Software": [
            {
                "Id": "bids::prov/#dcm2niix-khhkm7u1",
                "AltIdentifier": "RRID:SCR_023517",
                "Label": "dcm2niix",
                "Version": "v1.0.20220720"
            }
        ]
    }
    ```

### `Environment` records

Each `prov/[<label>/]prov-<label>_env.json` file is a JSON file describing `Environment` records for a provenance group.

This file MUST include a `Environments` key:

<!-- This block generates a metadata table.
The definitions of these fields can be found in
  src/schema/objects/metadata.yaml
and a guide for using macros can be found at
 https://github.com/bids-standard/bids-specification/blob/master/macros_doc.md
-->
{{ MACROS___make_metadata_table(
   {
      "Environments": "REQUIRED"
   }
) }}

Each object in the `Environments` array includes the following keys:

<!-- This block generates a table describing subfields within a metadata field.
The definitions of these fields can be found in
  src/schema/objects/metadata.yaml
and a guide for using macros can be found at
 https://github.com/bids-standard/bids-specification/blob/master/macros_doc.md
-->
{{ MACROS___make_subobject_table("metadata.Environments.items") }}


!!! bug
    TODO: Environment not currently defined in the context

!!! example "Example"
    ```JSON
    {
        "Environments": [
            {
                "Id": "bids::prov/#fedora-uldfv058",
                "Label": "Fedora release 36 (Thirty Six)",
                "OperatingSystem": "GNU/Linux 6.2.15-100.fc36.x86_64"
            }
        ]
    }
    ```

## Consistency of Ids

The following conventions are recommended in order to have consistent, human readable, and explicit [IRIs](https://www.w3.org/TR/json-ld11/#iris) as `Id` for provenance records objects. These principles also allow to identify where a record is described.

An `Id` identifying `Activity`, `Software`, and `Environment` provenance records inside files stored in a directory `<directory>` relatively to a BIDS dataset `<dataset>` SHOULD have the following form, where `<label>` is a human readable label for the record and `<uid>` is a unique group of chars:

```text
bids:<dataset>:prov#<name>-<uid>
```

!!! example "`Activity`, `Environment`, `Software` naming examples"
    - `bids:ds001734:prov#conversion-xfMMbHK1`: an `Activity` described inside the `ds001734` dataset;
    - `bids::prov#fedora-uldfv058`: an `Environment` described inside the current dataset.
    - `bids:derivatives:prov#fmriprep-r4kzzMt8`: a `Software` described inside the `derivatives` dataset.

An `Id` identifying an `Entity` provenance record for a file `<file>` relatively to a BIDS dataset `<dataset>` SHOULD have the following form:

```text
bids:<dataset>:<file>
```

!!! example "`Entity` naming examples"
    - `bids:ds001734:sub-002/anat/sub-02_T1w.nii`: an `Entity` describing a T1w file for subject `sub-002` in the `ds001734` dataset ;
    - `bids:derivatives:fmriprep/sub-001/func/sub-001_task-MGT_run-01_bold_space-MNI152NLin2009cAsym_preproc.nii.gz`: an `Entity` describing a bold file for subject `sub-001` in the `derivatives` dataset.

Here is another example that considers the following dataset:

<!-- This block generates a file tree.
A guide for using macros can be found at
 https://github.com/bids-standard/bids-specification/blob/master/macros_doc.md
-->
{{ MACROS___make_filetree_example(
    {
        "sourcedata": {
            "dicoms": {
                "...": "",
            },
        },
        "sub-001": {
            "anat": {
                "sub-001_T1w.nii.gz": "",
                "sub-001_T1w.json": ""
            },
        },
        "prov": {
            "prov-dcm2niix_act.json": "",
            "prov-dcm2niix_soft.json": ""
        }
    }
) }}

Ids of provenance records defined in `prov/prov-dcm2niix_soft.json` should start with `bids:dataset:prov#` or `bids::prov#`.

```JSON
{
    "Software": [
        {
            "Id": "bids:dataset:prov#dcm2niix-70ug8pl5",
            "Label": "dcm2niix",
            "Version": "v1.1.3"
        }
    ]
}
```

The previously described `Software` can be referred to in the `prov/prov-dcm2niix_act.json` file:

```JSON
{
    "Activities": [
        {
            "Id": "bids:dataset:prov#conversion-00f3a18f",
            "Label": "Conversion",
            "Command": "dcm2niix -o . -f sub-%i/anat/sub-%i_T1w sourcedata/dicoms",
            "AssociatedWith": "bids:dataset:prov#dcm2niix-70ug8pl5"
        }
    ]
}
```

The previously described `Activity` can be referred to in the `sub-001/anat/sub-001_T1w.json` sidecar JSON file:

```JSON
{
    "GeneratedBy":"bids:dataset:prov#conversion-00f3a18f"
}
```
